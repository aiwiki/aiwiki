---
layout: post
title: L√†m th·∫ø n√†o ƒë·ªÉ t√¥i c√≥ th·ªÉ s·ª≠ d·ª•ng selenium tr√™n ubuntu server [non-ui].
categories: [data engineer]
author: qxnam
tags: [scraping, selenium, ubuntu]
date: 2024-09-19
usemathjax: true
image: assets/selenium/selenium.png
description: 'Selenium l√† 1 th∆∞ vi·ªán m√£ ngu·ªìn m·ªü gi√∫p t∆∞∆°ng t√°c v·ªõi trang web. V·∫≠y li·ªáu selenium c√≥ ho·∫°t ƒë·ªông ƒë∆∞·ª£c tr√™n ubuntu server hay kh√¥ng (non-ui)?'
published: true
---

## Gi·ªõi thi·ªáu
<a id="introduction"></a>

Xin ch√†o $5$ t·ª∑ anh em, m√¨nh ƒëang l√†m $1$ c√¥ng vi·ªác c≈©ng h·∫øt s·ª©c ph·ªï bi·∫øn hi·ªán nay l√† c√†o d·ªØ li·ªáu. Nh∆∞ng v·∫•n ƒë·ªÅ c·ªßa m√¨nh kh√¥ng ho√†n to√†n l√† ph·∫£i d√πng selenium h·ªó tr·ª£ l·∫•y `page source` ƒë·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu, nh∆∞ng ƒë·ªÉ t·ªëi ∆∞u ngu·ªìn t√†i nguy√™n th√¨ m√¨nh c√≥ $1$ mini-pc ƒëang tr·ªëng n√™n m√¨nh quy·∫øt ƒë·ªãnh d√πng n√≥ ƒë·ªÉ ph·ª•c v·ª• vi·ªác c√†o d·ªØ li·ªáu.

M√¨nh d√πng selenium c≈©ng kh√¥ng nhi·ªÅu nh∆∞ng m√¨nh c≈©ng bi·∫øt 1 s·ªë **option** h·ªó tr·ª£ t·ªëi ∆∞u nh∆∞:
```python
from selenium.webdriver.chrome.options import Options
chrome_options = Options()
chrome_options.add_argument("--start-maximized")  # M·ªü r·ªông c·ª≠a s·ªï tr√¨nh duy·ªát
chrome_options.add_argument("disable-notifications")  # T·∫Øt th√¥ng b√°o
chrome_options.add_argument("--disable-extensions")  # T·∫Øt c√°c ti·ªán √≠ch m·ªü r·ªông
chrome_options.add_argument("--no-sandbox")  # Gi√∫p ·ªïn ƒë·ªãnh h∆°n tr√™n macOS
chrome_options.add_argument("--disable-dev-shm-usage")  # Gi·∫£m l·ªói chia s·∫ª b·ªô nh·ªõ
chrome_options.add_argument("--disable-gpu")  # T·∫Øt GPU
chrome_options.add_argument("--headless") # Ch·∫ø ƒë·ªô kh√¥ng hi·ªÉn th·ªã tr√¨nh duy·ªát
chrome_options.add_argument("--incognito") # Ch·∫ø ƒë·ªô ·∫©n danh
...
```

Th√¨ m√¨nh nh·∫≠n th·∫•y option `--headless` l√† n√≥ gi√∫p m√¨nh ch·∫°y driver ng·∫ßm m√† kh√¥ng c·∫ßn hi·ªÉn th·ªã giao di·ªán. Th√¨ l√∫c n√†y m√¨nh m·ªõi n·∫£y ra suy nghƒ© l√†: "N·∫øu option n√†y n√≥ ·∫©n giao di·ªán ƒëi th√¨ v·ªõi h·ªá ƒëi·ªÅu h√†nh ubuntu server kia kh√¥ng c√≥ giao di·ªán th√¨ c√≥ ch·∫°y ƒë∆∞·ª£c selenium kh√¥ng nh·ªâ?".

Th·∫ø l√† m√¨nh l√™n google search c√°c ki·ªÉu con ƒë√† ƒëi·ªÉu üßê v√† c≈©ng t√¨m ƒë∆∞·ª£c kha kh√° solution nh∆∞ng ƒëa ph·∫ßn m√¨nh kh√¥ng c√†i ƒë∆∞·ª£c. Loay hoay m·ªôt h·ªìi th√¨ m√¨nh c≈©ng l√†m ƒë∆∞·ª£c! yeah v√† h√¥m nay m√¨nh s·∫Ω truy·ªÅn l·∫°i b√≠ k√≠p n√†y cho c√°c b·∫°n. V·ªó tay c√°i nh·ªù üëèüëè

## Th·ª±c hi·ªán
<a id="do"></a>

Oke, v·∫≠y th√¨ m√¨nh b·∫Øt ƒë·∫ßu v·ªõi giao di·ªán ng·∫ßu l√≤i c·ªßa m·∫•y anh hacker m√† anh em h·∫±ng mong ∆∞·ªõc tr∆∞·ªõc.
T√¥i s·∫Ω d√πng m·ªôt s·ªë l·ªánh ƒë·ªÉ xem th√¥ng tin m√°y tr∆∞·ªõc.
```bash
$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 24.04 LTS
Release:        24.04
Codename:       noble
```

```bash
$ hostnamectl
 Static hostname: xxxx
       Icon name: computer-desktop
         Chassis: desktop üñ•Ô∏è
      Machine ID: xxxx
         Boot ID: xxxx
Operating System: Ubuntu 24.04 LTS                
          Kernel: Linux 6.8.0-44-generic
    Architecture: x86-64
 Hardware Vendor: Default string
  Hardware Model: Default string
Firmware Version: 5.13
   Firmware Date: Sat 2023-06-10
    Firmware Age: 1y 3month 1w 3d
```

ƒê·∫ßu ti√™n m√¨nh s·∫Ω c·∫≠p nh·∫≠t danh s√°ch c√°c g√≥i ph·∫ßn m·ªÅm v√† c√°c phi√™n b·∫£n m·ªõi nh·∫•t c√≥ s·∫µn t·ª´ c√°c kho l∆∞u tr·ªØ ƒë√£ c·∫•u h√¨nh tr√™n h·ªá th·ªëng.
```bash
$ sudo apt update
```

Ti·∫øp ƒë√≥ l√† c√†i ƒë·∫∑t c√°c g√≥i ph·∫ßn m·ªÅm `wget` v√† `unzip` ƒë·ªÉ t·∫£i v√† gi·∫£i n√©n c√°c t·ªáp tin t·ª´ internet.
```bash
$ sudo apt install -y wget unzip
```

Ti·∫øp t·ª•c t·∫£i v·ªÅ t·ªáp c√†i ƒë·∫∑t Google Chrome t·ª´ m√°y ch·ªß c·ªßa Google. (t√¥i hay d√πng chrome n·∫øu c√°c b·∫°n x√†i c√°i kh√°c th√¨ l√™n google t√¨m nh√©!)
```bash
$ wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
```

Khi ch·∫°y xong th√¨ t·ªáp tin s·∫Ω ƒë∆∞·ª£c t·∫£i xu·ªëng ·ªü th∆∞ m·ª•c hi·ªán t·∫°i, v√† m√¨nh s·∫Ω ph·∫£i di chuy·ªÉn t·ªáp tin n√†y sang th∆∞ m·ª•c `/tmp/`.
```bash
$ sudo mv ./google-chrome-stable_current_amd64.deb /tmp/
```

Cu·ªëi c√πng l√† c√†i ƒë·∫∑t chrome v√†o m√°y.
```bash
$ sudo apt install -y /tmp/google-chrome-stable_current_amd64.deb
```

üòú th·∫≠t ra c≈©ng kh√¥ng b·∫Øt bu·ªôc ph·∫£i di chuy·ªÉn file v√†o `/tmp/` ƒë√¢u nh∆∞ng m√¨nh mu·ªën m·ªçi th·ª© ƒë∆∞·ª£c s·∫Øp x·∫øp ho√†n h·∫£o gi·ªëng nh∆∞ *n√™n bi·∫øt v·ªã tr√≠ c·ªßa m√¨nh ·ªü ƒë√¢u trong tr√°i tim c√¥ ·∫•y v·∫≠y*.

## Th·ª≠ d√πng selenium v√† th·ª±c hi·ªán c√†o 1 trang web
<a id="practice"></a>

Setup xong r·ªìi th√¨ m√¨nh th·ª≠ xem nh∆∞ n√†o.
ƒê·∫ßu ti√™n m√¨nh t·∫°o m√¥i tr∆∞·ªùng ·∫£o (ƒëi·ªÅu lu√¥n lu√¥n ph·∫£i l√†m ƒë·∫ßu ti√™n khi b·∫Øt ƒë·∫ßu $1$ project).
```bash
$ python3 -m venv venv
```

Activate m√¥i tr∆∞·ªùng ·∫£o ƒë√≥.
```bash
$ source venv/bin/activate
```

M√¨nh s·∫Ω th·ª≠ th·ª±c hi·ªán l·∫•y th√¥ng tin c√°c c√¥ng ty trong trang web `https://pharmed.vn/exhibitors/companies`, trang web n√†y c·∫ßn c√≥ m√£ ƒë·ªÉ accept nh√©!

ƒê√¢y l√† m·∫´u
![sample](./assets/selenium/page_crawl.png)

M·ªçi ng∆∞·ªùi c√≥ th·ªÉ tham kh·∫£o source code c·ªßa m√¨nh nh√©.
```python
# main.py
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from webdriver_manager.chrome import ChromeDriverManager
from selenium.common.exceptions import NoSuchElementException
from time import sleep
from random import randint
from bs4 import BeautifulSoup
import pandas as pd
import ssl, os
ssl._create_default_https_context = ssl._create_stdlib_context
os.makedirs('screenshots', exist_ok=True)

home_url = 'https://pharmed.vn/exhibitors'
url_companies = home_url + '/companies?page={page_number}'
url_detail = home_url + '/company/{company_id}'

# Kh·ªüi t·∫°o ChromeDriver
service = Service(ChromeDriverManager().install())

chrome_options = Options()
chrome_options.add_argument("--start-maximized")
chrome_options.add_argument("disable-notifications")
chrome_options.add_argument("--disable-extensions")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.add_argument('--headless')
chrome_options.add_argument('--incognito')

def csv_to_xlsx(path):
    """
    Converts a CSV file to an XLSX file.
    
    Args:
    path: Path to the input CSV file.
    """
    # Read the CSV file
    df = pd.read_csv(path)
    
    # Save to an Excel file
    df.to_excel(f'{path[:-4]}.xlsx', index=False)
    return True

def scroll_down_until_element_found(driver, xpath, scroll_pause_time=1):
    """
    Scrolls down the page until the element specified by the given XPath is found.
    
    Args:
    driver: WebDriver object (Selenium).
    xpath: XPath string to locate the target element.
    scroll_pause_time: Time in seconds to pause between scrolls (default: 1).
    """
    last_height = driver.execute_script("return document.body.scrollHeight")

    while True:
        try:
            # Check if the element is present on the page
            element = driver.find_element(By.XPATH, xpath)
            if element:
                print("Element found!")
                break
        except NoSuchElementException:
            pass

        # Scroll down to the bottom of the page
        driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
        
        # Wait for the page to load
        sleep(scroll_pause_time)

        # Calculate new scroll height and compare with the last scroll height
        new_height = driver.execute_script("return document.body.scrollHeight")
        if new_height == last_height:
            print("Reached the bottom of the page, element not found.")
            break

        last_height = new_height

def enter_code(driver):
    '''
    Accept the code and submit the search form

    Args:
    driver: WebDriver object (Selenium).
    '''
    input_xpath = '//div[@class="job-field"]//input'
    keyword = 'JP3HP'
    driver.find_element(By.XPATH, input_xpath).send_keys(keyword)
    print(f'Entered keyword: {keyword}')
    sleep(1)
    submit_xpath = '//button[@type="submit"]'
    driver.find_element(By.XPATH, submit_xpath).click()
    print('Submitted search form')
    sleep(1)

def get_company_info(driver):
    '''
    Get company information
    
    Args:
    driver: WebDriver object (Selenium).
    '''
    data = {}
    soup = BeautifulSoup(driver.page_source, 'html.parser')
    data['name'] = soup.find('div', class_='job-single-info3').h3.text
    data['logo'] = soup.find('div', class_='job-thumb').img['src']
    data['address'] = soup.find('div', class_='job-single-info3').span.text.split('ƒê·ªãa ch·ªâ:')[-1].strip()
    data['description'] = soup.find('div', class_='job-single-info3').find('ul').find_all('li')[0].text.strip()
    data['about'] = soup.find('div', class_='job-details').p.text
    overviews = soup.find('div', class_='job-overview').find('ul').find_all('li')
    overviews = {item.find('h3').text.lower(): item.find('span').text.strip() for item in overviews}
    data.update(overviews)
    return data

def get_link(driver, pages):
    '''
    Get company links
    
    Args:
    driver: WebDriver object (Selenium).
    pages: List of page numbers.
    '''
    links = []
    for page_number in pages:
        driver.get(url_companies.format(page_number=page_number))
        sleep(randint(1, 2))
        page_xpath = '//div[@class="pagination pagination-homepage-v2"]'
        scroll_down_until_element_found(driver, page_xpath)
        link_path = '//div[@class="job-title-sec"]//h3//a'
        link = driver.find_elements(By.XPATH, link_path)
        links.extend([l.get_attribute('href') for l in link])
    return links

def get_data(driver, links, output = 'pharmed.csv'):
    '''
    Get company data

    Args:
    driver: WebDriver object (Selenium).
    links: List of company links.
    output: Output file path.
    '''
    stop_xpath = '//footer[@class="style2"]'
    for idx, link in enumerate(links, 1):
        try:
            print(f'> {idx}/{len(links)} -> {link}')
            driver.get(link)
            sleep(randint(1, 2))
            scroll_down_until_element_found(driver, stop_xpath)
            data = get_company_info(driver)
            name_screen = link.split('/')[-1]
            driver.save_screenshot(f"./screenshots/{name_screen}.png")
            data['link'] = link
            df = pd.DataFrame([data])
            df.to_csv(output, index=False, mode='a', header=not os.path.exists(output))
        except Exception as e:
            write_log(f'> {idx}/{len(links)} -> {link}: {e}')

def write_log(text):
    '''
    Write log to file

    Args:
    text: Log message.
    '''
    with open('log.txt', 'a', encoding='utf-8') as f:
        f.write(text+'\n')

if __name__ == "__main__":
    driver = webdriver.Chrome(service=service, options=chrome_options)
    driver.get(url_companies.format(page_number=1))
    sleep(randint(1, 2))
    enter_code(driver)
    links = get_link(driver, range(1, 25))
    get_data(driver, links)
    driver.quit()
```

Ch√∫c c√°c b·∫°n th√†nh c√¥ng!